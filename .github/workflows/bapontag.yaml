---
name: Build and push Docker Image on Tag

on:
  push:
    tags:
      - 'infra-tools-[0-9]+.[0-9]+.[0-9]+'
      - 'dbcmetrics-[0-9]+.[0-9]+.[0-9]+'
      - 'awx-ee-[0-9]+.[0-9]+.[0-9]+'

jobs:
  build_and_push:
    runs-on: ubuntu-latest

    steps:
      - name: Filter Tag name
        uses: olegtarasov/get-tag@v2.1
        id: tagName
        with:
          tagRegex: "(.+?(?=-[0-9]))"   # unabhängig von dbmetrics und infra-tools gives name
          tagRegexGroup: 1

      - name: Filter Version name
        uses: olegtarasov/get-tag@v2.1
        id: versionName
        with:
          tagRegex: "${{ steps.tagName.outputs.tag }}-(.*)"   # unabhängig von dbmetrics und infra-tools gives name
          tagRegexGroup: 1

      - name: Build and push
        uses: ./.github/workflows/bap.yaml
        with:
          image: schulcloud/${{ steps.tagName.outputs.tag }}
          tag: ${{ steps.versionName.outputs.tag }}
          context: ./${{ steps.tagName.outputs.tag }}/
