global
    log         127.0.0.1 local2

    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn 	{{ haproxy.maxconn }}   
    maxsessrate {{ haproxy.maxsessrate }}
{% if haproxy.maxsslconn is defined %}
    maxsslconn 	{{ haproxy.maxsslconn }}
{% endif %}
{% if haproxy.tune_ssl_cachesize is defined %}
    tune.ssl.cachesize {{ haproxy.tune_ssl_cachesize }}
{% endif %}
{% if haproxy.tune_ssl_default_dh_param is defined %}
    tune.ssl.default-dh-param {{ haproxy.tune_ssl_default_dh_param }}
{% endif %}

    user        haproxy
    group       haproxy
    daemon

    # turn on stats unix socket
    stats socket /var/lib/haproxy/stats
    stats timeout 30s

{% if haproxy.ssl_default_bind_ciphers is defined %}
    ssl-default-bind-ciphers {{ haproxy.ssl_default_bind_ciphers }}
{% endif %}
{% if haproxy.ssl_default_bind_options is defined %}
    ssl-default-bind-options {{ haproxy.ssl_default_bind_options }}
{% endif %}
{% if haproxy.ssl_default_server_ciphers is defined %}
    ssl-default-server-ciphers {{ haproxy.ssl_default_server_ciphers }}
{% endif %}
{% if haproxy.ssl_default_server_options is defined %}
    ssl-default-server-options {{ haproxy.ssl_default_server_options }}
{% endif %}
    
{% if haproxy.strict_limits %}
    # Crash when setrlimits fails
    strict-limits
{% endif %}

#---------------------------------------------------------------------
# common defaults that all the 'listen' and 'backend' sections will
# use if not designated in their block
#---------------------------------------------------------------------
defaults
    mode                    {{ haproxy.default_mode }}
    log                     {{ haproxy.default_log}}
{% for option in haproxy.options %}
    option                  {{ option }}
{% endfor %}
    retries                 {{ haproxy.retries }}
    timeout http-request    {{ haproxy.timeouts.http_request }}
    timeout queue           {{ haproxy.timeouts.queue }}
    timeout connect         {{ haproxy.timeouts.connect }}
    timeout client          {{ haproxy.timeouts.client }}
    timeout server          {{ haproxy.timeouts.server }}
    timeout http-keep-alive {{ haproxy.timeouts.http_keep_alive }}
    timeout check           {{ haproxy.timeouts.check }}
    timeout client-fin      {{ haproxy.timeouts.client_fin }}
    timeout server-fin      {{ haproxy.timeouts.server_fin }}

frontend haproxy
{% for ip in haproxy.frontend_ips %}
{% for port in haproxy.frontend_open_ports %}
    bind {{ ip }}:{{ port }} v4v6 transparent
{% endfor %}
{% endfor %}
    default_backend cluster

backend cluster
    mode http
    balance static-rr
{% for ip in haproxy.k8s_node_ips %}
    server worker-{{ loop.index }} {{ ip }}:80 check inter 10s fall 2 maxconn 12000
{% endfor %}
